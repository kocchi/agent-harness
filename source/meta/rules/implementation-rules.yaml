# 実装ルール（実装・コミット・レビュー時に適用）
# バーティカルスライス、コミット前レビュー、検査等、実装タスクに適用
#
# 用語定義は source/_shared/glossary.yaml を参照

version: "1.0"
last_updated: "2026-01-26"
glossary_ref: "../_shared/glossary.yaml"

rules:
  vertical_slice:
    name: "バーティカルスライス実行"
    description: "変更は Plan→実装→検査を一貫して完結させる"
    embed: true  # 超重要: Plan→実装→検査の流れを常に意識
    rationale:
      source: "research/investigations/2026-01-26_llm-context-rule-management.md"
      id: "R1"
      finding: "実装タスクの軸となるルール、重要度高"
    tool_config:
      cursor:
        alwaysApply: false
        type: "intelligent"
        description: "実装タスク、コード変更、機能追加時に適用"
      claude:
        priority: "high"
        location: "rules"
      devin:
        trigger: "on_demand"
        knowledge_type: "rule"
    checks:
      plan:
        - question: "Plan は存在するか？"
          method: "Plan ファイルまたは Plan mode の確認"
        - question: "tool_config でマルチツール対応を考慮しているか？"
          method: "変更がルール/エージェント/スキルの場合、tool_config の確認"
        - question: "SSoT 運用を守っているか？"
          method: "source/ のみを編集しているか確認"
      implement:
        - question: "バーティカルスライスで進んでいるか？"
          method: "Plan→実装→検査の流れになっているか確認"
      pre_commit:
        - question: "検査を実行したか？"
          method: "rules-validator を実行したか確認"
    flow:
      plan:
        description: "実装前に必ず計画を立てる（全タスク必須）"
        required: true
        steps:
          - "要件を明確化（質問で確認）"
          - "影響範囲を分析（読み取り専用）"
          - "中間生成物を作成（契約・失敗モード・テスト戦略）"
          - "並行分割を検討（独立タスクの識別、subagent_routing 参照）"
          - "計画をユーザーに提示"
          - "承認を得てから実装へ"
        intermediate_artifacts:
          contract: "何を作るか（スコープ、変更ファイル）"
          failure_modes: "何が壊れうるか（リスク、対策）"
          test_strategy: "どう検証するか（成功条件）"
        scaling:
          simple_task: "契約のみ必須、失敗モード・テスト戦略は任意"
          complex_task: "全中間生成物必須"
          判定基準: "変更ファイル数3以上、または新規ルール/エージェント/スキル追加"
        parallel_analysis:
          description: "並行分割の分析と計画"
          questions:
            - "独立して進められるタスクはあるか？"
            - "ファイル境界は明確か？"
            - "依存関係のあるタスクはどれか？"
          output: |
            ### 並行実行計画
            
            | タスク | 実行パターン | 依存 | 担当 |
            |--------|--------------|------|------|
            | ... | Parallel/Sequential/Background | ... | Main/SubAgent |
      implement:
        description: "計画に従って実装"
        steps:
          - "調査: Web リサーチで最新情報を確認"
          - "実装: ルール/コード/ドキュメントを一緒に変更"
          - "生成: ./scripts/generate.sh を実行"
      validate:
        description: "実装後に検査"
        steps:
          - "ssot-validator で整合性検査"
          - "動作検証（サブエージェント/スキルの場合）"
          - "自己レビュー（ルール違反がないか）"
    must:
      - "Plan フェーズで rules-validator サブエージェントを呼び出す"
      - "ルールを変えたら実装も変える"
      - "サブエージェント/スキル作成後は動作検証を行う"
      - "実装後に ssot-validator サブエージェントを呼び出す"
      - "コミット前に rules-validator サブエージェントを呼び出す"
    anti_patterns:
      - "Plan なしに実装を開始する"
      - "ルールだけ追加して既存ファイルを修正しない"
      - "検証せずにコミットする"
      - "調査せずに推測で実装する"
      - "中間生成物なしに承認を求める"
    validators:
      - "ssot-validator: SSoT 整合性"
      - "rules-validator: 全ルール検査"
      - "systematic-debugger: 問題発生時の要因分割"

  pre_commit_review:
    name: "コミット前レビュー"
    description: "コミット前に中間生成物での合意を必須とする（Human-in-the-Loop）"
    embed: true  # 超重要: コミット前に必ずユーザー承認を得る
    rationale:
      source: "research/investigations/2026-01-26_llm-context-rule-management.md"
      id: "R1"
      finding: "コミット時に必ず適用すべきルール"
    tool_config:
      cursor:
        alwaysApply: false
        type: "intelligent"
        description: "コミット、プルリクエスト作成時に適用"
      claude:
        priority: "high"
        location: "rules"
      devin:
        trigger: "on_demand"
        knowledge_type: "rule"
    checks:
      pre_commit:
        - question: "変更サマリをユーザーに提示したか？"
          method: "コミット前に変更内容を説明しているか確認"
        - question: "ユーザーの承認を得たか？"
          method: "承認の確認"
    must:
      - "コミット前に ssot-validator サブエージェントを呼び出す"
      - "コミット前に rules-validator サブエージェントを呼び出す"
      - "コミット前にユーザーに変更サマリを提示する"
      - "中間生成物（契約・失敗モード・テスト戦略）を明示する"
      - "学習を changelog.md に記録する"
      - "ルール変更が必要か確認する"
      - "ユーザーの承認を得てからコミットする"
    must_not:
      - "ユーザーの承認なしにコミットしない"
      - "一行ずつのコードレビューを強要しない"
    review_items:
      - "契約: 何を作るか（スコープ、変更ファイル）"
      - "失敗モード: 何が壊れうるか（リスク、対策）"
      - "テスト戦略: どう検証するか（成功条件）"
      - "学習: 何を学んだか（次回に活かすこと）"
      - "ルール変更: 学習をルールに反映すべきか"
    learning_extraction:
      description: "コミット前に学習を自動抽出して changelog.md に記録"
      rationale:
        source: "research/investigations/2026-01-26_context-control-implementation.md"
        finding: "learning 還流を自動化することで、手動記録の煩雑さを解消"
      extraction_prompt: |
        以下の変更から学習を抽出してください：

        ## 変更内容
        {git_diff}

        ## コミット履歴
        {git_log}

        ## 抽出観点
        - 何を試したか（実験・調査）
        - 何が失敗したか（問題・課題）
        - 何が成功したか（解決策・発見）
        - 次回に活かすべきこと（改善・注意点）

        ## 出力形式
        - 学習: [1文で簡潔に]
        - ルール変更の必要性: Yes/No
        - 変更が必要なルール: [該当する場合]
      output_format: |
        - {date}: {learning} ([proposal link])
    template: |
      ## コミット前レビュー

      ### 変更サマリ
      | 種別 | 内容 |
      |------|------|
      | 追加 | ... |
      | 変更 | ... |
      | 削除 | ... |

      ### 中間生成物との整合
      - 契約通りか: Yes/No
      - 失敗モード対策済みか: Yes/No

      ### 振り返り（自動抽出）
      - 学習: ...（次回に活かすこと）
      - ルール変更の必要性: Yes/No
      - 変更が必要なルール: ...

      コミットして良いか？

  slice_0:
    name: "Slice 0 で検証"
    description: "変更は小さく検証してから展開する"
    embed: false
    rationale:
      source: "general"
      finding: "大きな変更時に適用"
    tool_config:
      cursor:
        alwaysApply: false
        type: "intelligent"
        description: "大きな変更、リファクタリング時に適用"
      claude:
        priority: "medium"
        location: "rules"
      devin:
        trigger: "on_demand"
        knowledge_type: "guideline"
    checks:
      plan:
        - question: "大きな変更を Slice 0 で検証する計画か？"
          method: "変更ファイル数が多い場合、Slice 0 が計画に含まれているか確認"
      implement:
        - question: "Slice 0 の検証を先に行っているか？"
          method: "小さな変更から検証しているか確認"
    must:
      - "大きな変更は Slice 0 で先に検証する"
      - "検証方法を明確にする"
      - "検証結果を記録する"
    anti_patterns:
      - "一気に全体を変更する"
      - "検証せずに展開する"

  rules_validation:
    name: "ルール検査"
    description: "各ルールが徹底されているかを検査する"
    embed: false
    rationale:
      source: "research/investigations/2026-01-26_llm-context-rule-management.md"
      id: "R3"
      finding: "検査タスク時に適用"
    tool_config:
      cursor:
        alwaysApply: false
        type: "intelligent"
        description: "検査、バリデーション、コミット前に適用"
      claude:
        priority: "medium"
        location: "rules"
      devin:
        trigger: "on_demand"
        knowledge_type: "rule"
    timing:
      plan: "計画がルールに沿っているか"
      implement: "実装中にバーティカルスライスで進んでいるか"
      pre_commit: "全ルールを検査"
    checks:
      ssot:
        method: "generate.sh 実行後に git diff がないか"
        validator: "ssot-validator"
      ai_markdown:
        method: "rg で区切り線・太字・絵文字を検索"
        validator: "markdown-reviewer"
      vertical_slice:
        method: "ルール変更と実装変更が同時か、動作検証があるか"
        validator: "rules-validator"
      web_research_first:
        method: "調査結果が research/investigations/ に記録されているか"
        validator: "rules-validator"
    output: |
      ## ルール検査結果
      
      | ルール | 状態 | 詳細 |
      |--------|------|------|
      | ssot | OK/NG | ... |
      | ai_markdown | OK/NG | ... |
      | vertical_slice | OK/NG | ... |

  review:
    name: "レビュー観点"
    description: "PRレビュー時の確認事項"
    embed: false
    rationale:
      source: "general"
      finding: "PRレビュー時に適用"
    tool_config:
      cursor:
        alwaysApply: false
        type: "intelligent"
        description: "PRレビュー、コードレビュー時に適用"
      claude:
        priority: "medium"
        location: "rules"
      devin:
        trigger: "on_demand"
        knowledge_type: "guideline"
    checks:
      pre_commit:
        - question: "中間生成物が明示されているか？"
          method: "契約・失敗モード・テスト戦略の確認"
    points:
      - "中間生成物: 前提・仮説・スコープ・制約が明示されているか"
      - "テスト戦略: 検証方法と評価観点が記載されているか"
      - "契約: 関係者の役割と責務が明確か"
      - "ロールバック: 失敗モードと復帰手順が想定されているか"
      - "SSoT: source/ と generated/ が整合しているか"

  subagent_routing:
    name: "サブエージェントルーティング"
    description: "タスクを適切な実行パターン（並列/順次/バックグラウンド）にルーティングする判断基準"
    embed: true  # 並行判断基準を常にコンテキストに含める
    rationale:
      source: "research/investigations/2026-01-26_parallel-implementation-best-practices.md"
      finding: "並行実装で70-75%の時間短縮、呼び出し品質が失敗の主因"
    tool_config:
      cursor:
        alwaysApply: false
        type: "intelligent"
        description: "サブエージェント委譲、並行実装、タスク分割時に適用"
      claude:
        priority: "medium"
        location: "rules"
      devin:
        trigger: "on_demand"
        knowledge_type: "guideline"
    checks:
      plan:
        - question: "並行分割を検討したか？"
          method: "独立タスクの識別と実行パターンの選択を確認"
        - question: "サブエージェント呼び出しプロトコルを満たしているか？"
          method: "context, instructions, file_references, success_criteria の確認"
    patterns:
      parallel:
        name: "並列実行"
        description: "独立したタスクを複数のサブエージェントで同時に実行"
        conditions:
          - "3つ以上の独立タスク"
          - "タスク間で共有状態なし"
          - "ファイル境界が明確（重複なし）"
        examples:
          - "Frontend/Backend/DB の同時変更"
          - "複数の独立した調査タスク"
          - "異なるドメインの実装"
        anti_patterns:
          - "同じファイルを複数エージェントで編集"
          - "依存関係のあるタスクを並列化"
      sequential:
        name: "順次実行"
        description: "依存関係のあるタスクを順番に実行"
        conditions:
          - "タスク間に依存関係がある（B は A の出力が必要）"
          - "共有ファイル/状態がある（マージコンフリクトリスク）"
          - "スコープが不明確（先に理解が必要）"
        examples:
          - "Schema → API → Frontend のチェーン"
          - "調査 → 計画 → 実装"
          - "実装 → テスト → セキュリティ監査"
      background:
        name: "バックグラウンド実行"
        description: "メイン作業をブロックせずにリサーチ/分析タスクを実行"
        conditions:
          - "リサーチ/分析タスク（ファイル変更なし）"
          - "結果が即座に必要ではない"
          - "メイン作業をブロックしたくない"
        examples:
          - "Web リサーチ、ドキュメント調査"
          - "コードベース探索、分析"
          - "セキュリティ監査、パフォーマンスプロファイリング"
    invocation_protocol:
      description: "サブエージェントへの委譲時に必須の情報"
      required_elements:
        context: "タスクの背景と目的"
        instructions: "具体的な作業指示"
        file_references: "関連ファイルへの具体的な参照"
        success_criteria: "完了条件と期待される出力"
      template: |
        ## サブエージェント呼び出し
        
        ### コンテキスト
        [タスクの背景と目的]
        
        ### 指示
        [具体的な作業指示]
        
        ### 関連ファイル
        - [ファイルパスと説明]
        
        ### 成功条件
        - [完了条件]
        - [期待される出力形式]
      anti_patterns:
        - "曖昧な指示（「認証を直して」）"
        - "ファイル参照なし"
        - "成功条件なし"
      fallback:
        description: "サブエージェント失敗時の代替手段"
        strategies:
          - trigger: "resource_exhausted エラー"
            action: "並列 Tool Call で代替実行"
            example: "3つの独立ファイル編集を同時に Tool Call"
          - trigger: "サブエージェントタイムアウト"
            action: "タスクを分割して順次実行"
          - trigger: "コンテキスト不足エラー"
            action: "必要なファイルを読み込んでから再試行"
    must:
      - "Plan フェーズで並行分割を検討する"
      - "サブエージェント呼び出し時は invocation_protocol を満たす"
      - "実行パターン（parallel/sequential/background）を明示する"
      - "サブエージェント失敗時は fallback 戦略を適用する"
      - "独立タスクは並列 Tool Call で実行する"
    anti_patterns:
      - "全タスクを順次実行する（Over-serializing）"
      - "依存関係のあるタスクを並列化する（Over-parallelizing）"
      - "曖昧な指示でサブエージェントを呼び出す"

  changelog_update:
    name: "Changelog 更新"
    description: "変更は proposal を作成してから changelog に記録する"
    embed: true  # 超重要: proposal 作成漏れを防ぐ
    rationale:
      source: "research/proposals/2026-01-26_changelog-update-rule.md"
      finding: "proposal 作成を2回連続で忘れたため、ルール化して embed: true に"
    tool_config:
      cursor:
        alwaysApply: false
        type: "intelligent"
        description: "変更、コミット時に適用"
      claude:
        priority: "high"
        location: "rules"
      devin:
        trigger: "on_demand"
        knowledge_type: "rule"
    checks:
      pre_commit:
        - question: "proposal を作成したか？"
          method: "research/proposals/ に該当ファイルがあるか確認"
        - question: "changelog にリンクを追加したか？"
          method: "research/changelog.md を確認"
    must:
      - "変更がある場合は proposal を作成する（research/proposals/YYYY-MM-DD_xxx.md）"
      - "proposal を作成してから changelog にリンクを追加する"
      - "changelog は直近10件を維持する（超えたら古いものを削除）"
    flow:
      - "proposal を作成: research/proposals/YYYY-MM-DD_タイトル.md"
      - "changelog にリンクを追加: research/changelog.md"
      - "10件を超えたら古いエントリを削除"
    anti_patterns:
      - "proposal なしに changelog に追加する"
      - "changelog にリンクではなく説明文を書く"
      - "proposal を作成せずにコミットする"
    reference: "詳細は source/meta/skills/changelog-update.md を参照"
